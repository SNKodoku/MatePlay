<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Actividad: Funciones Lineales | MatePlay</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="../../css/style.css">

  <!-- ‚≠ê SISTEMA DE LOGROS -->
  <script src="../../js/logros.js"></script>
</head>

<body>

<!-- NAV -->
<header>
  <nav class="nav">
    <div class="logo">
      <div class="logo-icon">M</div>
      <span>MatePlay</span>
    </div>
    <div class="nav-links">
      <a href="../../nivel3.html">Volver al Nivel 3</a>
      <a href="../../logros.html">Logros ‚≠ê</a>
    </div>
  </nav>
</header>

<main>

  <section>
    <h1 class="section-title">Funciones Lineales</h1>
    <p class="section-subtitle">
      Observa la ecuaci√≥n y elige cu√°l gr√°fica corresponde a la recta.
    </p>
  </section>

  <section>
    <div class="game-container">

      <!-- IZQUIERDA -->
      <div>
        <span class="game-level-label">Nivel 3 ¬∑ Gr√°ficas</span>

        <p id="funcion-texto" class="game-question"></p>

        <canvas id="grafCanvas" width="350" height="300"
                style="background:#f9fafb;border-radius:12px;margin-bottom:1rem;">
        </canvas>

        <p class="section-subtitle" style="font-size:1rem;">Elige la gr√°fica correcta:</p>

        <div id="miniGraficas" class="levels-grid"></div>

        <p id="funcion-resultado" class="game-result"></p>

        <button class="btn btn-primary" onclick="nuevaFuncion()">
          üîÑ Nueva funci√≥n
        </button>
      </div>

      <!-- DERECHA -->
      <aside class="game-side">
        <p class="game-side-title">Consejos</p>
        <p><strong>Pendiente (m):</strong> Indica si sube o baja la recta.</p>
        <p><strong>Intersecci√≥n (b):</strong> Donde la recta cruza el eje Y.</p>
        <hr>
        <p><strong>Si m es positiva:</strong> la recta sube.</p>
        <p><strong>Si m es negativa:</strong> la recta baja.</p>
      </aside>

    </div>
  </section>

  <section style="margin-top:2rem;">
    <button class="btn btn-secondary" onclick="window.location.href='../nivel3.html'">
      ‚¨Ö Volver al Nivel 3
    </button>
  </section>

</main>

<footer>
  MatePlay ¬∑ Funciones Lineales ¬∑ 2025
</footer>

<!-- ‚≠ê POPUP ESTRELLA -->
<script>
  function popupEstrella() {
    let pop = document.createElement("div");
    pop.textContent = "‚≠ê ¬°Ganaste una estrella!";
    pop.style.position = "fixed";
    pop.style.bottom = "25px";
    pop.style.right = "25px";
    pop.style.padding = "15px 20px";
    pop.style.background = "#4f46e5";
    pop.style.color = "white";
    pop.style.borderRadius = "10px";
    pop.style.boxShadow = "0 4px 12px rgba(0,0,0,0.25)";
    pop.style.zIndex = "999";
    pop.style.opacity = "1";
    pop.style.transition = "opacity 1s ease";

    document.body.appendChild(pop);

    setTimeout(() => {
      pop.style.opacity = "0";
      setTimeout(() => pop.remove(), 1000);
    }, 1500);
  }
</script>

<!-- SCRIPT PRINCIPAL -->
<script>
  const canvas = document.getElementById("grafCanvas");
  const ctx = canvas.getContext("2d");

  let correctaIndex = 0;

  function nuevaFuncion() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    let m = Math.floor(Math.random() * 5) - 2;
    while (m === 0) m = Math.floor(Math.random() * 5) - 2;

    let b = Math.floor(Math.random() * 10) - 5;

    document.getElementById("funcion-texto").textContent =
      `y = ${m}x + ${b}`;

    dibujarPlano(ctx);
    dibujarRecta(ctx, m, b, "#ef4444", 2);

    generarMiniGraficas(m, b);
    document.getElementById("funcion-resultado").textContent = "";
  }

  function generarMiniGraficas(mCorrecta, bCorrecta) {
    const cont = document.getElementById("miniGraficas");
    cont.innerHTML = "";

    correctaIndex = Math.floor(Math.random() * 4);

    const opciones = [];

    for (let i = 0; i < 4; i++) {
      let m, b;

      if (i === correctaIndex) {
        m = mCorrecta;
        b = bCorrecta;
      } else {
        m = mCorrecta + (Math.floor(Math.random() * 5) - 2);
        if (m === 0) m = 1;
        b = bCorrecta + (Math.floor(Math.random() * 7) - 3);
      }

      opciones.push({ m, b });
    }

    opciones.forEach((op, index) => {
      let celda = document.createElement("div");
      celda.className = "level-card";
      celda.style.padding = "10px";

      let mini = document.createElement("canvas");
      mini.width = 150;
      mini.height = 120;
      mini.style.background = "#f9fafb";
      mini.style.borderRadius = "8px";

      celda.appendChild(mini);

      let miniCtx = mini.getContext("2d");
      dibujarPlano(miniCtx);
      dibujarRecta(miniCtx, op.m, op.b, "#3b82f6", 2);

      celda.onclick = () => evaluarFuncion(index);

      cont.appendChild(celda);
    });
  }

  function evaluarFuncion(indice) {
    const res = document.getElementById("funcion-resultado");

    if (indice === correctaIndex) {
      res.textContent = "¬°Correcto! üéâ";
      res.className = "game-result ok";

      // ‚≠ê GUARDAR LOGRO GLOBAL
      if (typeof sumarEstrella === "function") {
        sumarEstrella("nivel3_funcionesLineales");
      }

      popupEstrella();

    } else {
      res.textContent = "Incorrecto ‚ùå";
      res.className = "game-result bad";
    }
  }

  function dibujarPlano(contexto) {
    const W = contexto.canvas.width;
    const H = contexto.canvas.height;

    contexto.strokeStyle = "#9ca3af";
    contexto.lineWidth = 1;

    contexto.beginPath();
    contexto.moveTo(0, H / 2);
    contexto.lineTo(W, H / 2);
    contexto.stroke();

    contexto.beginPath();
    contexto.moveTo(W / 2, 0);
    contexto.lineTo(W / 2, H);
    contexto.stroke();
  }

  function dibujarRecta(contexto, m, b, color, width) {
    const W = contexto.canvas.width;
    const H = contexto.canvas.height;

    let x1 = -10;
    let y1 = m * x1 + b;

    let x2 = 10;
    let y2 = m * x2 + b;

    contexto.strokeStyle = color;
    contexto.lineWidth = width;

    contexto.beginPath();
    contexto.moveTo(W / 2 + x1 * 10, H / 2 - y1 * 10);
    contexto.lineTo(W / 2 + x2 * 10, H / 2 - y2 * 10);
    contexto.stroke();
  }

  nuevaFuncion();
</script>

</body>
</html>
